<app-breadcrumb></app-breadcrumb>

<h1>{{ isEditMode ? 'Update Season' : 'Create Season' }}</h1>

<div class="container">
    <form [formGroup]="seasonForm" (ngSubmit)="submitForm()">
        <div class="form-row">
            <mat-form-field appearance="outline" class="wide-field">
                <mat-label>Season Start Date</mat-label>
                <input
                    matInput
                    [matDatepicker]="startDatePicker"
                    [formControl]="startDateControl"
                    placeholder="Choose start date" />
                <mat-datepicker-toggle matSuffix [for]="startDatePicker"></mat-datepicker-toggle>
                <mat-datepicker #startDatePicker></mat-datepicker>
            </mat-form-field>

            <mat-form-field appearance="outline" class="wide-field">
                <mat-label>Season Start Time</mat-label>
                <input
                    matInput
                    [matTimepicker]="startTimePicker"
                    [formControl]="startTimeControl"
                    placeholder="Choose start time" />
                <mat-timepicker-toggle matSuffix [for]="startTimePicker"></mat-timepicker-toggle>
                <mat-timepicker #startTimePicker [interval]="'5m'"></mat-timepicker>
            </mat-form-field>
        </div>

        <div class="form-row">
            <mat-form-field appearance="outline" class="wide-field">
                <mat-label>Season End Date</mat-label>
                <input
                    matInput
                    [matDatepicker]="endDatePicker"
                    [formControl]="endDateControl"
                    placeholder="Choose end date" />
                <mat-datepicker-toggle matSuffix [for]="endDatePicker"></mat-datepicker-toggle>
                <mat-datepicker #endDatePicker></mat-datepicker>
            </mat-form-field>

            <mat-form-field appearance="outline" class="wide-field">
                <mat-label>Season End Time</mat-label>
                <input
                    matInput
                    [matTimepicker]="endTimePicker"
                    [formControl]="endTimeControl"
                    placeholder="Choose end time" />
                <mat-timepicker-toggle matSuffix [for]="endTimePicker"></mat-timepicker-toggle>
                <mat-timepicker #endTimePicker [interval]="'5m'"></mat-timepicker>
            </mat-form-field>
        </div>

        <mat-error *ngIf="seasonForm.hasError('endBeforeStart')">
            End date/time must be after start date/time
        </mat-error>

        <div class="form-row">
            <mat-form-field appearance="outline" class="wide-field">
                <mat-label>Teams</mat-label>

                <mat-chip-grid #chipGrid>
                    <mat-chip-row *ngFor="let teamId of selectedTeamIds" (removed)="removeTeam(teamId)">
                        {{ getTeamName(teamId) }}
                        <button matChipRemove>
                            <mat-icon>cancel</mat-icon>
                        </button>
                    </mat-chip-row>
                </mat-chip-grid>

                <input
                    matInput
                    placeholder="Add team..."
                    #teamInput
                    [matChipInputFor]="chipGrid"
                    [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                    [matChipInputAddOnBlur]="false"
                    [matAutocomplete]="auto"
                    (matChipInputTokenEnd)="addTeamFromInput($event)" />

                <mat-autocomplete #auto="matAutocomplete" (optionSelected)="selectTeam($event.option.value)">
                    <mat-option *ngFor="let team of filteredTeams" [value]="team.id">
                        {{ team.name }}
                    </mat-option>
                </mat-autocomplete>

                <mat-error *ngIf="seasonForm.get('teams')?.hasError('minArray')">
                    At least 2 teams are required
                </mat-error>
                <mat-error *ngIf="seasonForm.get('teams')?.hasError('maxArray')">
                    Maximum number of teams allowed
                </mat-error>
            </mat-form-field>
        </div>

        <div class="form-row stages-row">
            <h2 class="stages-header">Stages</h2>

            <div formArrayName="stages" class="stages-list">
                <div
                    *ngFor="let stageCtrl of stages.controls; let i = index"
                    [formGroupName]="i"
                    class="stage-row">
                    <div class="stage-order">{{ i + 1 }}</div>

                    <mat-form-field appearance="outline" class="stage-name-field">
                        <mat-label>Stage Name</mat-label>
                        <input matInput formControlName="name" placeholder="Enter stage name" />
                        <mat-error *ngIf="stageCtrl.get('name')?.hasError('required')">
                            Stage name is required
                        </mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="stage-type-field">
                        <mat-label>Stage Type</mat-label>
                        <mat-select formControlName="stageType">
                            <mat-option *ngFor="let option of stageTypeOptions" [value]="option.value">
                                {{ option.label }}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>

                    <div class="stage-actions">
                        <button
                            mat-icon-button
                            type="button"
                            aria-label="Move stage up"
                            (click)="moveStageUp(i)"
                            [disabled]="i === 0">
                            <mat-icon>arrow_upward</mat-icon>
                        </button>

                        <button
                            mat-icon-button
                            type="button"
                            aria-label="Move stage down"
                            (click)="moveStageDown(i)"
                            [disabled]="i === stages.length - 1">
                            <mat-icon>arrow_downward</mat-icon>
                        </button>

                        <button
                            mat-icon-button
                            type="button"
                            aria-label="Delete stage"
                            (click)="removeStage(i)">
                            <mat-icon>delete</mat-icon>
                        </button>
                    </div>
                </div>

                <button mat-stroked-button type="button" (click)="addStage()">Add Stage</button>
            </div>

            <mat-error *ngIf="seasonForm.get('stages')?.hasError('required')">
                At least one stage is required
            </mat-error>
        </div>

        <div class="actions">
            <button type="submit" mat-flat-button>SAVE</button>
            <button mat-stroked-button [routerLink]="['/admin/competitions', competitionId, 'seasons']">
                CANCEL
            </button>
            <button
                data-testid="delete-button"
                *ngIf="isEditMode"
                type="button"
                mat-flat-button
                class="warn"
                (click)="confirmDelete()">
                DELETE
            </button>
        </div>
    </form>
</div>
