DB_URL := "postgres://gainline:gainline@localhost:5432/gainline?sslmode=disable"

help:
    @echo ""
    @echo "Available targets:"
    @echo "  migrate-create name=<name>   Create a new migration"
    @echo "  migrate-up                   Run all up migrations (local DB)"
    @echo "  migrate-down                 Roll back one migration"
    @echo "  migrate-down-all             Roll back ALL migrations (DANGER)"
    @echo "  migrate-force version=<n>    Clear dirty migration and set version (DANGER)"
    @echo "  release-tag                  Interactive release tagging (main only)"
    @echo ""

migrate-create name="":
    @if [ -z "{{name}}" ]; then \
        echo "Usage: just migrate-create name=add_new_table"; \
        exit 1; \
    fi
    migrate create -ext sql -dir migrations -seq {{name}}

migrate-up:
    migrate \
        -path migrations \
        -database {{DB_URL}} \
        up

migrate-down:
    migrate \
        -path migrations \
        -database {{DB_URL}} \
        down 1

migrate-down-all:
    migrate \
        -path migrations \
        -database {{DB_URL}} \
        down

migrate-force version="":
    @if [ -z "{{version}}" ]; then \
        echo "Usage: just migrate-force version=<version_number>"; \
        exit 1; \
    fi
    migrate \
        -path migrations \
        -database {{DB_URL}} \
        force {{version}}

release-tag:
    @current=$$(git describe --tags --abbrev=0 2>/dev/null || echo "none"); \
    echo "üìå Current tag: $$current"; \
    echo ""; \
    read -p "Enter new tag (vX.Y.Z): " version; \
    if [ -z "$$version" ]; then \
        echo "‚ùå No version entered. Aborting."; \
        exit 1; \
    fi; \
    if git rev-parse "$$version" >/dev/null 2>&1; then \
        echo "‚ùå Tag $$version already exists."; \
        exit 1; \
    fi; \
    echo ""; \
    read -p "Confirm release tag '$$version'? (y/N): " confirm; \
    if [ "$$confirm" != "y" ]; then \
        echo "Aborted."; \
        exit 1; \
    fi; \
    if [ "$$(git branch --show-current)" != "main" ]; then \
        echo "‚ùå You must be on the main branch."; \
        exit 1; \
    fi; \
    if [ -n "$$(git status --porcelain)" ]; then \
        echo "‚ùå Working tree is dirty."; \
        exit 1; \
    fi; \
    echo ""; \
    echo "Tagging release $$version‚Ä¶"; \
    git pull origin main; \
    git tag -a $$version -m "Release $$version"; \
    git push origin $$version
