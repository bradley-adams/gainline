DB_URL := "postgres://gainline:gainline@localhost:5432/gainline?sslmode=disable"

help:
    @echo ""
    @echo "Available targets:"
    @echo "  migrate-create name=<name>   Create a new migration"
    @echo "  migrate-up                   Run all up migrations (local DB)"
    @echo "  migrate-down                 Roll back one migration"
    @echo "  migrate-down-all             Roll back ALL migrations (DANGER)"
    @echo "  migrate-force version=<n>    Clear dirty migration and set version (DANGER)"
    @echo "  release-tag                  Interactive release tagging (main only)"
    @echo "  db-test                      Run DB integration tests"
    @echo "  db-test-clean                Clear test cache, then run DB integration tests"
    @echo ""

migrate-create name="":
    @if [ -z "{{name}}" ]; then \
        echo "Usage: just migrate-create name=add_new_table"; \
        exit 1; \
    fi
    migrate create -ext sql -dir migrations -seq {{name}}

migrate-up:
    migrate \
        -path migrations \
        -database {{DB_URL}} \
        up

migrate-down:
    migrate \
        -path migrations \
        -database {{DB_URL}} \
        down 1

migrate-down-all:
    migrate \
        -path migrations \
        -database {{DB_URL}} \
        down

migrate-force version="":
    @if [ -z "{{version}}" ]; then \
        echo "Usage: just migrate-force version=<version_number>"; \
        exit 1; \
    fi
    migrate \
        -path migrations \
        -database {{DB_URL}} \
        force {{version}}

db-test:
    go test -tags=integration .

db-test-clean:
    go clean -testcache
    go test -tags=integration .