DB_URL := "postgres://gainline:gainline@localhost:5432/gainline?sslmode=disable"

help:
    @echo ""
    @echo "Available targets:"
    @echo "  migrate-create name=<name>   Create a new migration"
    @echo "  migrate-up                   Run all up migrations (local DB)"
    @echo "  migrate-down                 Roll back one migration"
    @echo "  migrate-down-all             Roll back ALL migrations (DANGER)"
    @echo "  migrate-force version=<n>    Clear dirty migration and set version (DANGER)"
    @echo "  release-tag                  Interactive release tagging (main only)"
    @echo "  db-test                      Run DB integration tests"
    @echo "  db-test-clean                Clear test cache, then run DB integration tests"
    @echo ""

migrate-create name="":
    @if [ -z "{{name}}" ]; then \
        echo "Usage: just migrate-create name=add_new_table"; \
        exit 1; \
    fi
    migrate create -ext sql -dir migrations -seq {{name}}

migrate-up:
    migrate \
        -path migrations \
        -database {{DB_URL}} \
        up

migrate-down:
    migrate \
        -path migrations \
        -database {{DB_URL}} \
        down 1

migrate-down-all:
    migrate \
        -path migrations \
        -database {{DB_URL}} \
        down

migrate-force version="":
    @if [ -z "{{version}}" ]; then \
        echo "Usage: just migrate-force version=<version_number>"; \
        exit 1; \
    fi
    migrate \
        -path migrations \
        -database {{DB_URL}} \
        force {{version}}

current-tag:
    @git describe --tags

release-tag:
	@echo "Current tag:"
	@git describe --tags
	@echo -n "Enter new tag (vX.Y.Z): "
	@read new_tag; \
	if [ -z "$$new_tag" ]; then \
		echo "❌ Tag cannot be empty. Release cancelled."; \
		exit 0; \
	fi; \
	if ! echo "$$new_tag" | grep -Eq '^v[0-9]+\.[0-9]+\.[0-9]+$$'; then \
		echo "❌ Invalid format. Tag must match v0.0.0"; \
		exit 0; \
	fi; \
	echo -n "Confirm release tag '$$new_tag'? (y/N): "; \
	read confirm; \
	if [ "$$confirm" != "y" ]; then \
		echo "❌ Release cancelled."; \
		exit 0; \
	fi; \
	echo "Tagging release $$new_tag…"; \
	git tag -a "$$new_tag" -m "Release $$new_tag"; \
	git push origin "$$new_tag"

db-test:
    go test -tags=integration .

db-test-clean:
    go clean -testcache
    go test -tags=integration .